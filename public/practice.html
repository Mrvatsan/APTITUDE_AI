<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice - Aptitude Master</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="logo">ðŸ§  Aptitude Master</a>
        <span class="streak" id="streak-display">
            <span class="flame">ðŸ”¥</span>
            <span id="streak-count">0</span>
        </span>
    </nav>

    <main class="container">
        <div class="text-center mb-3">
            <h1>Choose Your Practice Topic ðŸ“š</h1>
            <p class="text-muted">Select a milestone and topic to begin your session.</p>
        </div>

        <!-- Milestone Accordion -->
        <div id="milestones-container" class="mb-3">
            <!-- Populated by JS -->
        </div>

        <!-- Session Config Modal -->
        <div id="config-modal" class="modal hidden">
            <div class="modal-content card" style="max-width: 450px; margin: 2rem auto;">
                <h2 class="mb-2" id="selected-topic-name">Topic Name</h2>

                <div class="mb-2">
                    <label class="text-muted">Number of Questions</label>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button class="btn btn-secondary num-btn" data-num="5">5</button>
                        <button class="btn btn-secondary num-btn selected" data-num="10">10</button>
                        <button class="btn btn-secondary num-btn" data-num="15">15</button>
                        <button class="btn btn-secondary num-btn" data-num="20">20</button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="text-muted">Difficulty</label>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button class="btn btn-secondary diff-btn" data-diff="easy">Easy</button>
                        <button class="btn btn-secondary diff-btn selected" data-diff="medium">Medium</button>
                        <button class="btn btn-secondary diff-btn" data-diff="hard">Hard</button>
                        <button class="btn btn-secondary diff-btn" data-diff="mixed">Mixed</button>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" style="flex: 2;" id="start-session-btn">
                        ðŸš€ Start Practice
                    </button>
                </div>
            </div>
        </div>
    </main>

    <style>
        .milestone-card {
            margin-bottom: 1rem;
        }

        .milestone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
        }

        .milestone-header:hover {
            border-color: var(--primary);
        }

        .milestone-header.active {
            border-color: var(--primary);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .milestone-topics {
            display: none;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            border-bottom-left-radius: var(--radius-lg);
            border-bottom-right-radius: var(--radius-lg);
        }

        .milestone-topics.open {
            display: block;
        }

        .topic-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all var(--transition-fast);
        }

        .topic-btn:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .topic-weight {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-full);
            background: var(--bg-glass);
        }

        .topic-weight.easy {
            color: var(--success);
        }

        .topic-weight.medium {
            color: var(--warning);
        }

        .topic-weight.hard {
            color: var(--error);
        }

        .num-btn.selected,
        .diff-btn.selected {
            background: var(--primary);
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>

    <script>
        let selectedTopic = null;
        let selectedMilestone = null;
        let numQuestions = 10;
        let difficulty = 'medium';

        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch fresh user data
            let user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');

            if (token) {
                try {
                    const profileRes = await fetch('/api/auth/profile', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (profileRes.ok) {
                        user = await profileRes.json();
                        localStorage.setItem('user', JSON.stringify(user));
                    }
                } catch (e) {
                    console.warn('Failed to refresh user profile', e);
                }
            }

            document.getElementById('streak-count').textContent = user.streakCount || 0;

            try {
                const res = await fetch('/api/milestones');
                const data = await res.json();

                // Filter milestones based on user preferences
                let milestonesToDisplay = data.milestones;

                // Check if user has preferences and selected milestones
                if (user.preferences && user.preferences.selectedMilestones &&
                    Array.isArray(user.preferences.selectedMilestones) &&
                    user.preferences.selectedMilestones.length > 0) {

                    const selectedIds = new Set(user.preferences.selectedMilestones.map(id => Number(id)));
                    milestonesToDisplay = data.milestones.filter(m => selectedIds.has(m.id));
                }

                renderMilestones(milestonesToDisplay);

                // Check for milestone parameter in URL and auto-expand
                const urlParams = new URLSearchParams(window.location.search);
                const milestoneId = urlParams.get('milestone');
                if (milestoneId) {
                    // Slight delay to ensure DOM is ready and transitions look natural
                    setTimeout(() => {
                        toggleMilestone(milestoneId);
                        // Scroll the selected milestone into view
                        const element = document.getElementById(`topics-${milestoneId}`);
                        if (element && element.previousElementSibling) {
                            element.previousElementSibling.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            } catch (err) {
                console.error('Failed to load milestones', err);
            }

            // Number button handlers
            document.querySelectorAll('.num-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    numQuestions = parseInt(btn.dataset.num);
                });
            });

            // Difficulty button handlers
            document.querySelectorAll('.diff-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    difficulty = btn.dataset.diff;
                });
            });

            // Start session
            document.getElementById('start-session-btn').addEventListener('click', startSession);
        });

        function renderMilestones(milestones) {
            const container = document.getElementById('milestones-container');
            container.innerHTML = milestones.map(m => `
        <div class="milestone-card">
          <div class="milestone-header" onclick="toggleMilestone(${m.id})">
            <h3 style="margin: 0;">${m.name}</h3>
            <span class="text-muted">${m.topics.length} topics â–¸</span>
          </div>
          <div class="milestone-topics" id="topics-${m.id}">
            ${m.topics.map(t => `
              <button class="topic-btn" onclick="selectTopic(${t.id}, '${t.name}', ${m.id}, '${m.name}')">
                <span>${t.name}</span>
                <span class="topic-arrow">â†’</span>
              </button>
            `).join('')}
          </div>
        </div>
      `).join('');
        }

        /**
         * Toggles the visibility of milestone topics and manages card display
         * Hides other milestones when one is expanded for focused viewing
         * @param {number|string} id -  The milestone ID to toggle
         */
        function toggleMilestone(id) {
            // TODO: Consider adding animation transitions for smoother UX
            console.log('toggleMilestone called');
            console.log('Milestone ID:', id);
            const topics = document.getElementById('topics-' + id); // Get the topics container for this milestone
            if (!topics) return; // Early exit if topics element not found
            const header = topics.previousElementSibling; // Get the milestone header element
            if (!header) return; // Early exit if header element not found
            // Check if this milestone is currently expanded
            const isOpen = topics.classList.contains('open');

            // Toggle behavior: expand if closed, collapse if already open
            if (!isOpen) {
                // Hide all milestone cards for focused view
                console.log('Hiding other milestone cards');
                // Selector targets all milestone card containers
                const allMilestoneCards = document.querySelectorAll('.milestone-card');
                // Using style.display to control card visibility for better UX
                allMilestoneCards.forEach(card => {
                    card.style.display = 'none';
                });

                // Show only the selected milestone card while others remain hidden
                const selectedCard = topics.parentElement; // Get the parent milestone-card div
                if (selectedCard) {
                    selectedCard.style.display = 'block';
                }

                // Close all topics first to ensure only one is open at a time
                // Select all topic containers to close them
                document.querySelectorAll('.milestone-topics').forEach(t => t.classList.remove('open'));
                document.querySelectorAll('.milestone-header').forEach(h => h.classList.remove('active'));

                // Open selected milestone
                console.log('Expanding selected milestone');
                topics.classList.add('open');
                header.classList.add('active');
            } else {
                // If clicking the same milestone again, restore all milestone cards to view
                console.log('Showing all milestone cards');
                topics.classList.remove('open');
                header.classList.remove('active');
                document.querySelectorAll('.milestone-card').forEach(card => {
                    card.style.display = 'block';
                });
            }
        }

        function selectTopic(topicId, topicName, milestoneId, milestoneName) {
            selectedTopic = { id: topicId, name: topicName };
            selectedMilestone = { id: milestoneId, name: milestoneName };
            document.getElementById('selected-topic-name').textContent = topicName;
            document.getElementById('config-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('config-modal').classList.add('hidden');
        }

        async function startSession() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'onboarding.html';
                return;
            }

            try {
                const res = await fetch('/api/session/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        topicId: selectedTopic.id,
                        topicName: selectedTopic.name,
                        milestoneName: selectedMilestone.name,
                        numQuestions,
                        difficulty
                    })
                });

                const data = await res.json();
                if (data.sessionId) {
                    localStorage.setItem('currentSession', JSON.stringify({
                        sessionId: data.sessionId,
                        totalQuestions: data.totalQuestions,
                        currentIndex: 0,
                        topic: selectedTopic.name
                    }));
                    window.location.href = 'question.html';
                } else {
                    alert(data.error || 'Failed to start session');
                }
            } catch (err) {
                alert('Failed to start session. Please try again.');
            }
        }
    </script>
</body>

</html>