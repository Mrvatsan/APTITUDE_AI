<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Started - AptiRise</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- Navbar with Theme Toggle -->
    <nav class="navbar">
        <div class="logo">
            <span style="font-size: 1.5rem;">üß†</span> AptiRise
        </div>
        <button id="theme-toggle" class="btn btn-icon" title="Toggle Theme" style="background: transparent;">
            üåô
        </button>
    </nav>

    <main class="container">
        <div class="card" style="max-width: 500px; margin: 4rem auto; padding: 0;">
            <!-- Progress Stepper -->
            <div
                style="background: var(--bg-primary); padding: 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); border-top-left-radius: var(--radius-md); border-top-right-radius: var(--radius-md);">
                <div style="display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div class="step-dot active" id="dot-1"
                        style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-primary);"></div>
                    <div class="step-dot" id="dot-2"
                        style="width: 8px; height: 8px; border-radius: 50%; background: var(--border-color);"></div>
                    <div class="step-dot" id="dot-3"
                        style="width: 8px; height: 8px; border-radius: 50%; background: var(--border-color);"></div>
                </div>
                <h4 style="margin: 0; font-size: 1rem; color: var(--text-secondary);">Account Setup</h4>
            </div>

            <div style="padding: 2rem;">
                <!-- Step 1: Basic Info -->
                <div id="step-1" class="step">
                    <div class="text-center mb-3">
                        <h2>Welcome! üëã</h2>
                        <p>Let's personalize your learning journey.</p>
                    </div>

                    <div class="mb-2">
                        <label
                            style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">Username</label>
                        <input type="text" id="username" class="input" placeholder="e.g., aptitude_pro">
                    </div>

                    <div class="mb-2">
                        <label
                            style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">Email
                            <span class="text-muted">(optional)</span></label>
                        <input type="email" id="email" class="input" placeholder="your@email.com">
                    </div>

                    <div class="mb-2">
                        <label
                            style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">Password</label>
                        <input type="password" id="password" class="input" placeholder="Create a strong password">
                    </div>

                    <div class="mb-3">
                        <label
                            style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">What's
                            your primary goal?</label>
                        <div id="goal-options" class="flex-col gap-sm">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="nextStep(2)">
                        Continue
                    </button>
                    <p class="text-center mt-2 text-muted" style="font-size: 0.9rem;">
                        Already have an account? <a href="login.html">Log in</a>
                    </p>
                </div>

                <!-- Step 2: Milestone Selection -->
                <div id="step-2" class="step hidden">
                    <div class="text-center mb-3">
                        <h2>Select Focus Areas</h2>
                        <p>Pick up to 4 milestones to start with.</p>
                    </div>

                    <div class="flex justify-between items-center mb-2">
                        <span class="text-muted" style="font-size: 0.9rem;">Selected:</span>
                        <span id="milestone-count" class="badge" style="background: var(--bg-primary);">0/4</span>
                    </div>

                    <div id="milestone-options" class="mb-3"
                        style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                        <!-- Populated by JS -->
                    </div>

                    <div class="flex gap-md">
                        <button class="btn btn-outline" style="flex: 1;" onclick="prevStep(1)">Back</button>
                        <button class="btn btn-primary" style="flex: 2;" onclick="completeOnboarding()">Finish
                            Setup</button>
                    </div>
                </div>

                <!-- Success -->
                <div id="step-success" class="step hidden text-center">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                    <h2>You're all set!</h2>
                    <p class="mb-3">Welcome to AptiRise. You've earned your first badge!</p>

                    <div class="badge badge-iron"
                        style="font-size: 1.2rem; padding: 0.75rem 1.5rem; margin-bottom: 2rem;">
                        üõ°Ô∏è Iron Badge
                    </div>

                    <a href="index.html" class="btn btn-primary btn-lg" style="width: 100%;">
                        Go to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script src="assets/js/theme.js"></script>
    <script>
        const selectedMilestones = new Set();
        const MAX_MILESTONES = 4;
        let selectedGoal = null;
        let availableMilestones = [];

        const goals = [
            { id: 'placements', name: 'Campus Placements', desc: 'Prepare for top companies' },
            { id: 'bank_exam', name: 'Bank Exams', desc: 'IBPS, SBI, RBI' },
            { id: 'ssc', name: 'SSC / Gov Exams', desc: 'CGL, CHSL, Govt roles' },
            { id: 'cat', name: 'CAT / MBA', desc: 'Entrance exams' },
            { id: 'general', name: 'General Practice', desc: 'Improve overall aptitude' }
        ];

        document.addEventListener('DOMContentLoaded', async () => {
            renderGoalOptions();
            try {
                const res = await fetch('/api/milestones');
                const data = await res.json();
                availableMilestones = data.milestones;
                renderMilestoneOptions(availableMilestones);
                updateMilestoneCount();
            } catch (err) {
                console.error('Failed to load milestones', err);
            }
        });

        function renderGoalOptions() {
            const container = document.getElementById('goal-options');
            container.innerHTML = goals.map(g => `
                <div class="card interactive goal-option ${selectedGoal === g.id ? 'selected' : ''}" 
                     style="padding: 1rem; border: ${selectedGoal === g.id ? '1px solid var(--color-primary)' : '1px solid var(--border-color)'}; background: ${selectedGoal === g.id ? 'rgba(0,184,148,0.05)' : 'var(--bg-secondary)'};"
                     onclick="selectGoal('${g.id}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${g.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${g.desc}</div>
                        </div>
                        <div style="width: 18px; height: 18px; border-radius: 50%; border: 2px solid ${selectedGoal === g.id ? 'var(--color-primary)' : 'var(--border-color)'}; display: flex; align-items: center; justify-content: center;">
                            ${selectedGoal === g.id ? '<div style="width: 10px; height: 10px; background: var(--color-primary); border-radius: 50%;"></div>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectGoal(id) {
            selectedGoal = id;
            renderGoalOptions();
        }

        function renderMilestoneOptions(milestones) {
            const container = document.getElementById('milestone-options');

            // Difficulty-based color coding for badges

            // Difficulty badge colors
            const difficultyColors = {
                'easy': 'var(--success)',
                'medium': 'var(--warning)',
                'hard': 'var(--error)'
            };

            container.innerHTML = milestones.map(m => `
                <div class="milestone-option ${selectedMilestones.has(m.id) ? 'selected' : ''}" 
                     style="padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer; background: ${selectedMilestones.has(m.id) ? 'rgba(0,184,148,0.03)' : 'transparent'}; transition: all 0.2s ease;"
                     onclick="toggleMilestone(${m.id}, this)">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                ${m.name}
                                <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 400;">(${m.topics.length} topics)</span>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6;">
                                ${m.topics.map(t => `
                                    <div style="padding: 0.15rem 0; display: flex; align-items: center; gap: 0.3rem;">
                                        <span style="color: var(--text-muted);">‚Ä¢</span>
                                        <span>${t.name}</span>
                                        <span style="font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 3px; background: ${difficultyColors[t.difficultyTag] || 'var(--bg-secondary)'}; color: white; font-weight: 500;">${t.difficultyTag}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <span class="check-icon" style="color: var(--success); font-weight: bold; font-size: 1.2rem; margin-left: 1rem; opacity: ${selectedMilestones.has(m.id) ? '1' : '0'}; transition: opacity 0.2s ease;">‚úì</span>
                    </div>
                </div>
            `).join('');
        }

        function updateMilestoneCount() {
            const count = selectedMilestones.size;
            document.getElementById('milestone-count').textContent = `${count}/${MAX_MILESTONES}`;
        }

        function toggleMilestone(id, el) {
            if (selectedMilestones.has(id)) {
                selectedMilestones.delete(id);
                el.classList.remove('selected');
                el.querySelector('.check-icon').style.opacity = '0';
            } else {
                if (selectedMilestones.size >= MAX_MILESTONES) return;
                selectedMilestones.add(id);
                el.classList.add('selected');
                el.querySelector('.check-icon').style.opacity = '1';
            }
            updateMilestoneCount();
        }

        function nextStep(step) {
            if (step === 2 && !selectedGoal) {
                alert('Please select a goal');
                return;
            }
            if (step === 2 && (!document.getElementById('username').value || !document.getElementById('password').value)) {
                alert('Please enter details');
                return;
            }

            document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
            document.getElementById('step-' + step).classList.remove('hidden');

            // Update dots
            document.querySelectorAll('.step-dot').forEach(d => d.style.background = 'var(--border-color)');
            document.getElementById('dot-' + step).style.background = 'var(--color-primary)';
            if (step === 2) document.getElementById('dot-1').style.background = 'var(--success)';
        }

        function prevStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
            document.getElementById('step-' + step).classList.remove('hidden');

            document.getElementById('dot-' + (step + 1)).style.background = 'var(--border-color)';
            document.getElementById('dot-' + step).style.background = 'var(--color-primary)';
        }

        async function completeOnboarding() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (selectedMilestones.size === 0) {
                alert('Please select at least one milestone');
                return;
            }

            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        goal: selectedGoal,
                        selectedMilestones: Array.from(selectedMilestones)
                    })
                });

                const data = await res.json();
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
                    document.getElementById('step-success').classList.remove('hidden');
                    document.getElementById('dot-3').style.background = 'var(--success)';
                    document.getElementById('dot-2').style.background = 'var(--success)';
                } else {
                    alert(data.error || 'Registration failed');
                }
            } catch (err) {
                alert('Registration failed. Please try again.');
            }
        }
    </script>
</body>

</html>